53.38-2-4.99
53.38-2-4.99+4.99/3
#SRH
#净化器 垃圾袋 洗衣凝珠 shampoo 洗洁精
srh<-77.40+9.21+11+6.86+4.32+18.2/2+8.24+8.97+15.90/3+17.94/3
#wwb
wwb<-16.52/2+11/2+15.12/4+17.12+8.6/2+3.08/2+19.61+12.67/2+8.58/2+129+4.32/2+3.3+32.43/7*3+8.6+11.19/2+9.48/2+11.81/2+10.74/2+1+4.99/2
#syt
syt<-16.52/2+12.91+11/2+15.12/4+8.6/2+2.26+10.73+3.08/2+18.2/2+12.67/2+8.58/2+4.32/2+8.42+8.6+2.26+32.43/7+11.19/2+9.48/2+11.81/2+10.74/2+1+4.99/2
#wy
wy<-11+11+15.12/2+32.43/7*3+48.0533
#zyx
zyx<-5.41+9.97+8.24+4.3+16.11
#plate
plate<-17.2
srh
#wwb
wwb<-16.52/2+11/2+15.12/4+17.12+8.6/2+3.08/2+19.61+12.67/2+8.58/2+129+4.32/2+3.3+32.43/7*3+8.6+11.19/2+9.48/2+11.81/2+10.74/2+1+4.99/2
#syt
syt<-16.52/2+12.91+11/2+15.12/4+8.6/2+2.26+10.73+3.08/2+18.2/2+12.67/2+8.58/2+4.32/2+8.42+8.6+2.26+32.43/7+11.19/2+9.48/2+11.81/2+10.74/2+1+4.99/2
#wy
wy<-11+11+15.12/2+32.43/7*3+48.0533
#zyx
zyx<-5.41+9.97+8.24+4.3+16.11
#plate
plate<-17.2
syt
#wy
wy<-11+11+15.12/2+32.43/7*3+48.0533
wy
#zyx
zyx<-5.41+9.97+8.24+4.3+16.11
zyx
t<-50
0.027*t+(1/3)*0.00025*(t-40)^3
t<-40
0.027*t+(1/3)*0.00025*(t-40)^3
2^3
t<-50
0.027*t+(1/3)*0.00025*((t-40)^3)
exp(-(1.4333-1.08))
t<-60
0.027*t+(1/3)*0.00025*((t-40)^3)
exp(-(2.2867-1.08))
library(alr4)
library(tidyverse)
ggplot(data = Mitchell, aes(x = Month, y = Temp)) +
geom_point()
ggplot(data = Mitchell, aes(x = Month, y = Temp)) +
geom_point() +
theme(aspect.ratio = 1 / 4)
# write.csv(Mitchell, "data/mitchell.csv", row.names = F)
library(ggrepel)
# Add city names as a column
UBSprices$City <- rownames(UBSprices)
# Define the cities to annotate
annotate_cities <- c("Vilnius", "Budapest", "Nairobi", "Mumbai", "Seoul")
# Create the plot
ggplot(UBSprices, aes(x = rice2003, y = rice2009)) +
geom_point() +
geom_smooth(method = "lm",
se = F,
color = "black",
linetype = "dashed") +
geom_abline(slope = 1,
intercept = 0,
color = "black",
linetype = "solid") +
geom_text(data = UBSprices[UBSprices$City %in% annotate_cities, ],
aes(label = City),
nudge_y =5,
nudge_x = -3) +
labs(x = "Rice Price in 2003",
y = "Rice Price in 2009") +
theme_minimal()
library(alr4)
library(tidyverse)
ggplot(data = Mitchell, aes(x = Month, y = Temp)) +
geom_point() +
theme(aspect.ratio = 1 / 8)
ggplot(data = Mitchell, aes(x = Month, y = Temp)) +
geom_point() +
theme(aspect.ratio = 1 / 10)
ggplot(data = Mitchell, aes(x = Month, y = Temp)) +
geom_point() +
theme(aspect.ratio = 1 / 12)
install.packages("tidymodels")
install.packages("kableExtra")
install.packages("alr4")
library(tidyverse)
library(tidymodels)
library(kableExtra)
library(alr4)
library(tidyverse)
library(tidymodels)
library(kableExtra)
library(alr4)
library(tidyverse)
library(tidymodels)
library(kableExtra)
library(alr4)
library(tidyverse)
library(tidymodels)
library(kableExtra)
library(alr4)
(-1/1.17+1)*117+(2*100/1.17-200)
-(3*100/(2*1.17))+117/2-100
(100/(2*1.17))+117/2-100
sqrt(2/pi)
10*exp(-1)
205/42
exp(2.5128+1.3454)*{(ln2)}^{0.8085}
exp(2.5128+1.3454)*ln(2)^(0.8085)
exp(2.5128+1.3454)*log(2)^(0.8085)
9.2888^2
142,372 + 324,603 + 28,932 + 230,422
142372 + 324603 + 28932 + 230422
2284/726329
1/ 0.00314458
1007 + 403 + 882 + 458
rm(list=ls())
library(data.table)
library(stringr)
library(plyr)
library(dplyr)
library(haven)
library(tidyr)
library(readr)
library(ggplot2)
library(GGally)
library(ggsci)
library(ggpubr)
library(reshape2)
library(survival)
library(survminer)
library(forcats)
library(gridtext)
setwd("~/Desktop/Zhou Lab/Breast Cancer PRO project/Analysis/wwanbing/output/TTFD+Covariates")
Merged_TTFD <- read_csv("Merged_PRO_TTFD_01OCT2025.csv")
setwd("~/Desktop/Zhou Lab/Breast Cancer PRO project/Merge/wwanbing/output")
Merge_EQLQ_24APR2025 <- read_csv("Merge_EQLQ_24APR2025.csv")
Merged_TTFD <- Merged_TTFD %>%
left_join(
Merge_EQLQ_24APR2025 %>% distinct(UID, STDID),
by = "UID"
)
df <- Merged_TTFD
library(tidyverse)
library(survival)
library(survminer)
# 计算 PRO 恶化个数：只取以 censored_ 开头且不是 censored10P_ 的列
cens_cols <- names(df) |>
keep(~ startsWith(.x, "censored_") && !startsWith(.x, "censored10P_"))
df <- df %>%
mutate(
PRO_deteriorated_n = rowSums(dplyr::select(., all_of(cens_cols)) == 0, na.rm = TRUE),
PRO_group = case_when(
PRO_deteriorated_n == 0 ~ "0",
PRO_deteriorated_n <= 3 ~ "1-3",
PRO_deteriorated_n <= 6 ~ "4-6",
PRO_deteriorated_n <= 9 ~ "7-9",
TRUE ~ "≥10"
)
) %>%
mutate(PRO_group = factor(PRO_group, levels = c("0","1-3","4-6","7-9","≥10")))
# 清洗
df_cln <- df %>%
mutate(
PFSDY = na_if(PFSDY, -999),
DTHDY = na_if(DTHDY, -999),
PFS   = ifelse(PFS %in% c(0,1), PFS, NA),
DTH   = ifelse(DTH %in% c(0,1), DTH, NA)
) %>% filter(!is.na(PRO_group))
# 统一主题（更大字体）
custom_theme <- theme_classic(base_size = 18) +  # base_size 提升
theme(
axis.title  = element_text(size = 18, face = "bold"),
axis.text   = element_text(size = 16),
legend.title= element_text(size = 18, face = "bold"),
legend.text = element_text(size = 16),
plot.title  = element_text(size = 20, face = "bold", hjust = 0.5),
plot.margin = margin(8, 12, 8, 12)
)
# ---------- PFS ----------
df_pfs <- df_cln %>% filter(!is.na(PFSDY), !is.na(PFS))
fit_pfs <- survfit(Surv(PFSDY, PFS) ~ PRO_group, data = df_pfs)
plt_pfs <- ggsurvplot(
fit_pfs, data = df_pfs,
risk.table = TRUE, risk.table.height = 0.25,
pval = TRUE, pval.size = 6, conf.int = FALSE,
xlab = "Days to Progression/Censoring",
ylab = "Progression-Free Survival",
legend.title = "No. of PRO Deteriorations",
legend.labs  = levels(df_pfs$PRO_group),
legend = "right",
ggtheme = custom_theme,
size = 1.1,              # 线更粗
censor.size = 3,         # 删失点更大
tables.theme = theme_minimal(base_size = 14),
tables.colnames = TRUE,
risk.table.y.text.col = TRUE,
risk.table.y.text = FALSE
)
# ---------- OS ----------
df_os <- df_cln %>% filter(!is.na(DTHDY), !is.na(DTH))
fit_os <- survfit(Surv(DTHDY, DTH) ~ PRO_group, data = df_os)
plt_os <- ggsurvplot(
fit_os, data = df_os,
risk.table = TRUE, risk.table.height = 0.25,
pval = TRUE, pval.size = 6, conf.int = FALSE,
xlab = "Days to Death/Censoring",
ylab = "Overall Survival",
legend.title = "No. of PRO Deteriorations",
legend.labs  = levels(df_os$PRO_group),
legend = "right",
ggtheme = custom_theme,
size = 1.1,
censor.size = 3,
tables.theme = theme_minimal(base_size = 14),
tables.colnames = TRUE,
risk.table.y.text.col = TRUE,
risk.table.y.text = FALSE
)
# 显示
print(plt_pfs)
print(plt_os)
plt_pfs <- ggsurvplot(
fit_pfs, data = df_pfs,
risk.table = TRUE, risk.table.height = 0.25,
pval = TRUE, pval.size = 6, conf.int = FALSE,
xlab = "Days to Progression/Censoring",
ylab = "Progression Free Survival",
legend.title = "No. of PRO Deteriorations",
legend.labs  = levels(df_pfs$PRO_group),
legend = "top",
ggtheme = custom_theme,
size = 1.1,              # 线更粗
censor.size = 3,         # 删失点更大
tables.theme = theme_minimal(base_size = 14),
tables.colnames = TRUE,
risk.table.y.text.col = TRUE,
risk.table.y.text = FALSE
)
# ---------- OS ----------
df_os <- df_cln %>% filter(!is.na(DTHDY), !is.na(DTH))
fit_os <- survfit(Surv(DTHDY, DTH) ~ PRO_group, data = df_os)
plt_os <- ggsurvplot(
fit_os, data = df_os,
risk.table = TRUE, risk.table.height = 0.25,
pval = TRUE, pval.size = 6, conf.int = FALSE,
xlab = "Days to Death/Censoring",
ylab = "Overall Survival",
legend.title = "No. of PRO Deteriorations",
legend.labs  = levels(df_os$PRO_group),
legend = "top",
ggtheme = custom_theme,
size = 1.1,
censor.size = 3,
tables.theme = theme_minimal(base_size = 14),
tables.colnames = TRUE,
risk.table.y.text.col = TRUE,
risk.table.y.text = FALSE
)
# 显示
print(plt_pfs)
print(plt_os)
# 输出路径
out_dir <- "~/Desktop/Zhou Lab/Breast Cancer PRO project/Analysis/wwanbing/Figure_summary/OCT16"
# 导出 PFS 图
ggsave(file.path(out_dir, "PFS_PRO_group.eps"), plot = plt_pfs$plot, width = 6, height = 4.2, dpi = 400, device = cairo_ps)
ggsave(file.path(out_dir, "PFS_PRO_group.tiff"), plot = plt_pfs$plot, width = 6, height = 4.2, dpi = 400, device = "tiff", compression = "lzw")
# 导出 OS 图
ggsave(file.path(out_dir, "OS_PRO_group.eps"), plot = plt_os$plot, width = 6, height = 4.2, dpi = 400, device = cairo_ps)
ggsave(file.path(out_dir, "OS_PRO_group.tiff"), plot = plt_os$plot, width = 6, height = 4.2, dpi = 400, device = "tiff", compression = "lzw")
df_pfs <- df_cln %>% filter(!is.na(PFSDY), !is.na(PFS)) %>%
mutate(followup_days = PFSDY)
rm(list=ls())
library(data.table)
library(stringr)
library(plyr)
library(dplyr)
library(haven)
library(tidyr)
library(readr)
library(ggplot2)
library(GGally)
library(ggsci)
library(ggpubr)
library(reshape2)
library(survival)
library(survminer)
library(forcats)
library(gridtext)
setwd("~/Desktop/Zhou Lab/Breast Cancer PRO project/Analysis/wwanbing/output/TTFD+Covariates")
Merged_TTFD <- read_csv("Merged_PRO_TTFD_01OCT2025.csv")
setwd("~/Desktop/Zhou Lab/Breast Cancer PRO project/Merge/wwanbing/output")
Merge_EQLQ_24APR2025 <- read_csv("Merge_EQLQ_24APR2025.csv")
Merged_TTFD <- Merged_TTFD %>%
left_join(
Merge_EQLQ_24APR2025 %>% distinct(UID, STDID),
by = "UID"
)
df <- Merged_TTFD
# 1) 只取 censored_*（排除 censored10P_*）
cens_cols <- grep("^censored_[A-Z0-9]+$", names(df), value = TRUE)
# 2) 计算每位患者 TTFD 恶化个数（censored == 0）
df <- df %>%
mutate(
PRO_deteriorated_n = rowSums(dplyr::select(., all_of(cens_cols)) == 0, na.rm = TRUE),
PRO_group = case_when(
PRO_deteriorated_n == 0 ~ "0",
PRO_deteriorated_n >= 1 & PRO_deteriorated_n <= 3 ~ "1-3",
PRO_deteriorated_n >= 4 & PRO_deteriorated_n <= 6 ~ "4-6",
PRO_deteriorated_n >= 7 & PRO_deteriorated_n <= 9 ~ "7-9",
PRO_deteriorated_n >= 10 ~ "≥10"
)
) %>%
mutate(PRO_group = factor(PRO_group, levels = c("0", "1-3", "4-6", "7-9", "≥10")))
# 检查分组频数
table(df$PRO_group)
# 统一把 -999 设为 NA，并只保留 0/1 事件值
df_cln <- df %>%
mutate(
PFSDY = na_if(PFSDY, -999),
DTHDY = na_if(DTHDY, -999),
PFS   = ifelse(PFS %in% c(0,1), PFS, NA),
DTH   = ifelse(DTH %in% c(0,1), DTH, NA)
) %>%
filter(!is.na(PRO_group))
df_pfs <- df_cln %>% filter(!is.na(PFSDY), !is.na(PFS)) %>%
mutate(followup_days = PFSDY)
cor.test(df_pfs$PRO_deteriorated_n, df_pfs$followup_days, method = "spearman")
df_pfs %>% group_by(PRO_group) %>%
summarise(med_follow = median(followup_days, na.rm=TRUE),
n = n())
View(df_pfs)
colnames(df_pfs)
# 检查分组频数
table(df$PRO_group)
colnames(df)
library(dplyr)
library(ggplot2)
library(patchwork)
library(tidyr)
# —— 1. 选出 15 个 TTFD 变量（排除 TTFD10P_*）——
ttfd_cols <- grep("^TTFD10_[A-Z0-9]+$", names(df), value = TRUE)
# 检查一下
print(ttfd_cols)
# 通常应包含：TTFD10_AP, TTFD10_CO, TTFD10_DI, ..., TTFD10_SF
# —— 2. 计算每个变量在不同 PRO_group 下的中位数/均值 ——
summary_long <- lapply(ttfd_cols, function(colname) {
df %>%
group_by(PRO_group) %>%
summarise(
n = n(),
median_TTFD = median(.data[[colname]], na.rm = TRUE),
mean_TTFD   = mean(.data[[colname]], na.rm = TRUE)
) %>%
mutate(TTFD_Var = colname)
}) %>% bind_rows()
# —— 3. 同时加入 PFSDY 以便比较 ——
summary_pfs <- df %>%
group_by(PRO_group) %>%
summarise(
n = n(),
median_PFSDY = median(PFSDY, na.rm = TRUE),
mean_PFSDY   = mean(PFSDY, na.rm = TRUE)
) %>%
mutate(TTFD_Var = "PFSDY")
# 合并
summary_all <- bind_rows(summary_long, summary_pfs)
# 打印查看结果
print(summary_all)
library(dplyr)
# 选 15 个 TTFD 列（排除 TTFD10P_*）
ttfd_cols <- grep("^TTFD10_[A-Z0-9]+$", names(df), value = TRUE)
# 清洗 PFSDY（若上游未清过）
df <- df %>% mutate(PFSDY = dplyr::na_if(PFSDY, -999))
# 先算 PFSDY 在各 PRO_group 的中位数/均值
summary_pfsdy <- df %>%
group_by(PRO_group) %>%
summarise(
n_group        = n(),
median_PFSDY   = median(PFSDY, na.rm = TRUE),
mean_PFSDY     = mean(PFSDY, na.rm = TRUE),
.groups = "drop"
)
# 对每个 TTFD 变量，计算本组统计，并把 PFSDY 的统计并到同一行
summary_all <- lapply(ttfd_cols, function(colname) {
df %>%
group_by(PRO_group) %>%
summarise(
n_TTFD      = sum(!is.na(.data[[colname]])),
median_TTFD = median(.data[[colname]], na.rm = TRUE),
mean_TTFD   = mean(.data[[colname]], na.rm = TRUE),
.groups = "drop"
) %>%
left_join(summary_pfsdy, by = "PRO_group") %>%
mutate(
TTFD_Var   = colname,
# 方便比较：PFSDY - TTFD 的中位数差
median_diff = median_PFSDY - median_TTFD
)
}) %>% bind_rows()
print(summary_all)
View(summary_all)
for (colname in ttfd_cols) {
df_long <- df %>%
select(PRO_group, PFSDY, !!sym(colname)) %>%
rename(TTFD = !!sym(colname)) %>%
tidyr::pivot_longer(cols = c(TTFD, PFSDY),
names_to = "Type", values_to = "Days")
p <- ggplot(df_long, aes(PRO_group, Days, fill = Type)) +
geom_boxplot(outlier.shape = NA, position = position_dodge(width = 0.8), alpha = 0.75) +
labs(title = paste0(colname, " vs PFSDY by PRO_group"),
x = "PRO deterioration group", y = "Days") +
theme_classic(base_size = 14) + theme(legend.position = "top")
print(p)
}
ttfd_cols
for (colname in ttfd_cols) {
df_long <- df %>%
select(PRO_group, PFSDY, !!sym(colname)) %>%
rename(TTFD = !!sym(colname)) %>%
tidyr::pivot_longer(cols = c(TTFD, PFSDY),
names_to = "Type", values_to = "Days")
p <- ggplot(df_long, aes(PRO_group, Days, fill = Type)) +
geom_boxplot(outlier.shape = NA, position = position_dodge(width = 0.8), alpha = 0.75) +
labs(title = paste0(colname, " vs PFSDY by PRO_group"),
x = "PRO deterioration group", y = "Days") +
theme_classic(base_size = 14) + theme(legend.position = "top")
print(p)
}
library(patchwork)
library(ggplot2)
library(dplyr)
library(tidyr)
make_box <- function(colname) {
df %>%
select(PRO_group, PFSDY, !!sym(colname)) %>%
rename(TTFD = !!sym(colname)) %>%
pivot_longer(c(TTFD, PFSDY), names_to = "Type", values_to = "Days") %>%
ggplot(aes(PRO_group, Days, fill = Type)) +
geom_boxplot(outlier.shape = NA, position = position_dodge(width = 0.8), alpha = 0.75) +
labs(title = paste0(colname, " vs PFSDY"), x = NULL, y = "Days") +
theme_classic(base_size = 12) +
theme(legend.position = "top")
}
plots <- lapply(ttfd_cols, make_box)
# 3×5 拼图，合并图例
combined <- wrap_plots(plots, ncol = 5, guides = "collect") +
plot_annotation(title = "TTFD10_* vs PFSDY by PRO_group") &
theme(legend.position = "top")
combined  # 显示
df_0_10 <- df %>%
filter(PRO_group %in% c("0", "≥10"))
table(df_0_10$PRO_group)
View(df_0_10)
### Updated version for 19_tumor_size_analysis.R
rm(list=ls())
library(data.table)
library(stringr)
library(plyr)
library(dplyr)
library(haven)
library(tidyr)
library(readr)
library(ggplot2)
library(ggpubr)
library(GGally)
library(ggsci)
library(reshape2)
library(survival)
library(survminer)
library(RColorBrewer)
library(forcats)
###Do tumor size correlate with symptoms deterioration?
setwd("~/Desktop/Zhou Lab/Breast Cancer PRO project/Analysis/data")
tumor_all<-read_csv("PRO_TTFD_tumor_20251015.csv")
Monolix_2001 <- read_csv("Breast_Monolix_2001_tumor.csv")
Monolix_2004 <- read_csv("Breast_Monolix_2004_tumor.csv")
Monolix_2001$Year <- "2001"
Monolix_2004$Year <- "2004"
Monolix_2001$UID <- as.character(Monolix_2001$UID)
Monolix_2004$UID <- as.character(Monolix_2004$UID)
Monolix <- bind_rows(Monolix_2001, Monolix_2004)
PRO_2001 <- read_csv("PRO_Size_2001.csv")
PRO_2004 <- read_csv("PRO_Size_2004.csv")
PRO_2001$Year <- "2001"
PRO_2004$Year <- "2004"
PRO_2001$UID <- as.character(PRO_2001$UID)
PRO_2004$UID <- as.character(PRO_2004$UID)
PRO <- bind_rows(PRO_2001, PRO_2004)
# left_join censored variable
#> length(unique(PRO$UID))
#[1] 356
#> length(unique(tumor_all$UID))
#[1] 436
censor_cols <- grep("^censored", colnames(tumor_all), value = TRUE)
censor_df <- tumor_all %>%
select(UID, all_of(censor_cols)) %>%
distinct()
PRO <- PRO %>%
left_join(censor_df, by = "UID")
Monolix$UID <- as.character(Monolix$UID)
vars_to_merge <- c("UID", "AGE", "MENOS", "CHEMO", "HORMON", "ERS", "PGRS", "ECOG")
monolix_clinical <- Monolix %>%
select(all_of(vars_to_merge)) %>%
distinct()
PRO <- PRO %>%
left_join(monolix_clinical, by = "UID")
colnames(PRO)
